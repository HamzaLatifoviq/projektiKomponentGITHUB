@{
    ViewBag.Title = "Hotel1";
}

<h2>Hotel Stone Bridge</h2>
<div class="container mt-4">
    <h2 class="text-center">Rezervoni Hotelin</h2>
    <div class="row">
        <!-- Carousel për fotografitë -->
        <div class="col-md-8">
            <div id="hotelCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/Content/BesnikFotoHotel/stonebridge1.jpg" class="d-block w-100" alt="Pamje nga Hotel Stone Bridge">
                    </div>
                    <div class="carousel-item">
                        <img src="/Content/BesnikFotoHotel/stonebridge2.jpg" class="d-block w-100" alt="Pamje e dhomës në Hotel Stone Bridge">
                    </div>
                    <div class="carousel-item">
                        <img src="/Content/BesnikFotoHotel/stonebridge3.jpg" class="d-block w-100" alt="Pamje e restorantit në Hotel Stone Bridge">
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#hotelCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#hotelCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>
        <!-- Përshkrimi i Hotelit -->
        <div class="col-md-4">
            <h5>Përshkrimi i Hotelit</h5>
            <p>
                Stone Bridge Hotel është një hotel luksoz me 5 yje i vendosur në zemër të Shkupit,
                pranë urës historike prej guri mbi lumin Vardar.
                Me një arkitekturë elegante dhe një atmosferë që ndërthur traditën me luksin modern,
                ky hotel ofron një përvojë të paharrueshme për vizitorët e tij.
            </p>
            <ul>
                Karakteristikat Kryesore
                <li>Vendndodhje e Përsosur: I pozicionuar në qendër të qytetit, pranë monumenteve kryesore si Ura e Gurit dhe Kalaja e Shkupit, duke e bërë të lehtë eksplorimin e atraksioneve kulturore dhe historike të qytetit.</li>
                <li>Akomodim Komod: Dhomat janë të dizajnuara me kujdes, duke ofruar një ambient të rehatshëm dhe të pastër për pushim pas një dite të ngarkuar.</li>
                <li>Shërbime Shtesë: Hoteli ofron një gamë të gjerë shërbimesh për të përmbushur nevojat e mysafirëve, duke përfshirë një pishinë të brendshme dhe një qendër fitnesi.</li>
            </ul>
        </div>
    </div>

    <div class="container mt-4">
        <h3 class="text-center mt-5">Rezervoni Periudhën dhe Dhomën</h3>
        <form id="reservationForm" class="mt-3">
            <input type="hidden" id="hotelId" value="1" />

            <!-- Data e rezervimit me ikonë kalendari -->
            <div class="form-group position-relative" style="max-width:320px; margin-bottom:1rem;">
                <label for="reservationRange">Zgjidhni Periudhën:</label>
                <input type="text" id="reservationRange" class="form-control" placeholder="Zgjidhni intervalin e datave" required style="padding-left:2.5rem;" />
                <span class="input-icon" style="position:absolute; left:12px; top:60%; transform: translateY(-50%); font-size:18px; color:#555; pointer-events:none;">📅</span>
            </div>

            <!-- Numri i adultëve me ikonë personi -->
            <div class="form-group position-relative" style="max-width:320px; margin-bottom:1rem;">
                <label for="adultsCount">Adultë:</label>
                <input type="number" id="adultsCount" class="form-control" min="1" max="30" value="2" required style="padding-left:2.5rem;" />
                <span class="input-icon" style="position:absolute; left:12px; top:60%; transform: translateY(-50%); font-size:18px; color:#555; pointer-events:none;">👤</span>
            </div>

            <!-- Numri i fëmijëve me ikonë personi -->
            <div class="form-group position-relative" style="max-width:320px; margin-bottom:1rem;">
                <label for="childrenCount">Fëmijë (0-17 vjeç):</label>
                <input type="number" id="childrenCount" class="form-control" min="0" max="10" value="0" style="padding-left:2.5rem;" />
                <span class="input-icon" style="position:absolute; left:12px; top:60%; transform: translateY(-50%); font-size:18px; color:#555; pointer-events:none;">👤</span>
            </div>

            <!-- Numri i dhomave me ikonë shtepie/dhoma -->
            <div class="form-group position-relative" style="max-width:320px; margin-bottom:1rem;">
                <label for="roomsCount">Dhomat:</label>
                <input type="number" id="roomsCount" class="form-control" min="1" max="10" value="1" required style="padding-left:2.5rem;" />
                <span class="input-icon" style="position:absolute; left:12px; top:60%; transform: translateY(-50%); font-size:18px; color:#555; pointer-events:none;">🏠</span>
            </div>

            <button type="submit" class="btn btn-primary mt-3">Rezervoni</button>
        </form>

        <div id="message" class="mt-3"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Inicializimi i Flatpickr për zgjedhjen e intervalit të datave
            flatpickr("#reservationRange", {
                mode: "range", // Lejon zgjedhjen e intervalit të datave
                dateFormat: "Y-m-d", // Formati i datës
                minDate: "today", // Data minimale është data e sotme
            });

            // Konstanta e çmimeve
            const pricePerAdultPerNight = 40;
            const pricePerChildPerNight = 10;
            const pricePerRoomPerNight = 40;
            const messageDiv = document.getElementById("message");

            // Funksioni për llogaritjen e çmimit total
            function calculatePrice() {
                const adultsCount = parseInt(document.getElementById("adultsCount").value, 10) || 0;
                const childrenCount = parseInt(document.getElementById("childrenCount").value, 10) || 0;
                const roomsCount = parseInt(document.getElementById("roomsCount").value, 10) || 1;
                const reservationRange = document.getElementById("reservationRange").value;

                // Kalkulimi i numrit të netëve
                let nightsCount = 1;
                if (reservationRange) {
                    const dates = reservationRange.split(" to ");
                    if (dates.length === 2) {
                        const start = new Date(dates[0]);
                        const end = new Date(dates[1]);
                        if (end > start) {
                            nightsCount = Math.max((end - start) / (1000 * 60 * 60 * 24), 1);
                        } else {
                            messageDiv.innerHTML = "<div class='alert alert-danger'>Data e përfundimit duhet të jetë pas datës së fillimit.</div>";
                            return;
                        }
                    } else {
                        messageDiv.innerHTML = "";
                        return;
                    }
                } else {
                    messageDiv.innerHTML = "";
                    return;
                }

                // Llogaritja e çmimit total
                const totalPrice =
                    nightsCount *
                    (adultsCount * pricePerAdultPerNight +
                        childrenCount * pricePerChildPerNight +
                        roomsCount * pricePerRoomPerNight);

                messageDiv.innerHTML = "<div class='alert alert-info'>Çmimi total: $" + totalPrice.toFixed(2) + "</div>";
            }

            // Lidh eventet input dhe change për të kalkuluar çmimin
            document.getElementById("adultsCount").addEventListener("input", calculatePrice);
            document.getElementById("childrenCount").addEventListener("input", calculatePrice);
            document.getElementById("roomsCount").addEventListener("input", calculatePrice);
            document.getElementById("reservationRange").addEventListener("change", calculatePrice);

            // Submit i formës për rezervim
            document.getElementById("reservationForm").addEventListener("submit", function (event) {
                event.preventDefault();

                const hotelId = document.getElementById("hotelId").value;
                const reservationRange = document.getElementById("reservationRange").value;
                const adultsCount = parseInt(document.getElementById("adultsCount").value, 10);
                const childrenCount = parseInt(document.getElementById("childrenCount").value, 10);
                const roomsCount = parseInt(document.getElementById("roomsCount").value, 10);

                if (!reservationRange || !adultsCount || !roomsCount) {
                    messageDiv.innerHTML = '<div class="alert alert-danger">Ju lutem plotësoni të gjitha fushat e detyrueshme.</div>';
                    return;
                }

                fetch('/Reservation/CheckAvailability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hotelId: parseInt(hotelId), reservationRange, adultsCount, childrenCount, roomsCount })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Gabim gjatë kontrollit të disponueshmërisë: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.available) {
                            return fetch('/Reservation/MakeReservation', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ hotelId, reservationRange, adultsCount, childrenCount, roomsCount })
                            });
                        } else {
                            throw new Error('Nuk ka dhoma të lira për këtë periudhë.');
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Gabim gjatë procesit të rezervimit: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(reservationData => {
                        console.log("Përgjigja nga serveri:", reservationData); // Debugging për të parë përgjigjen
                        if (reservationData.success) {
                            messageDiv.innerHTML = '<div class="alert alert-success">Rezervimi u krye me sukses. Për detaje, kontrolloni email-in tuaj!</div>';
                        } else {
                            throw new Error(reservationData.message || 'Rezervimi dështoi. Provoni përsëri.');
                        }
                    })

                    .catch(error => {
                        console.error("Gabim:", error.message);
                        messageDiv.innerHTML = `<div class="alert alert-danger">${error.message || 'Ndodhi një gabim. Ju lutem provoni përsëri më vonë.'}</div>`;
                    });
            });
        });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
